using Azure.Identity;
using Microsoft.Graph;

namespace SharePoint;

public sealed class SharePointUploader
{
    private readonly GraphServiceClient _graphClient;

    public SharePointUploader()
    {
        var credential = new DefaultAzureCredential();
        _graphClient = new GraphServiceClient(credential);
    }

    public async Task UploadAsync(
        string siteId,
        string documentLibrary,
        string filePath)
    {
        if (!File.Exists(filePath))
            throw new FileNotFoundException(filePath);

        var drives = await _graphClient
            .Sites[siteId]
            .Drives
            .GetAsync();

        var drive = drives!.Value!
            .First(d => d.Name == documentLibrary);

        using var stream = File.OpenRead(filePath);

        await _graphClient
            .Drives[drive.Id]
            .Root
            .ItemWithPath(Path.GetFileName(filePath))
            .Content
            .PutAsync(stream);
    }
}
