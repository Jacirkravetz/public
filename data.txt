Sub CreatePivotTableInWorksheet(wsSource As Worksheet)
    Dim wb As Workbook
    Dim wsPivot As Worksheet
    Dim ptCache As PivotCache
    Dim pt As PivotTable
    Dim dataRange As Range
    Dim pivotSheetName As String
    Dim pivotField As PivotField
    Dim dataBodyRange As Range
    
    ' Obtém o Workbook associado à Worksheet
    Set wb = wsSource.Parent
    
    ' Define o intervalo de dados de A até AB
    With wsSource
        Set dataRange = .Range("A1:AB" & .Cells(.Rows.Count, "A").End(xlUp).Row)
    End With
    
    ' Cria ou recria a aba "PivotTabela"
    pivotSheetName = "PivotTabela"
    On Error Resume Next
    Application.DisplayAlerts = False
    wb.Sheets(pivotSheetName).Delete ' Exclui a planilha se já existir
    Application.DisplayAlerts = True
    On Error GoTo 0
    
    Set wsPivot = wb.Sheets.Add
    wsPivot.Name = pivotSheetName
    
    ' Cria o cache da PivotTable
    Set ptCache = wb.PivotCaches.Create( _
        SourceType:=xlDatabase, _
        SourceData:=dataRange)
    
    ' Cria a PivotTable na aba "PivotTabela"
    Set pt = ptCache.CreatePivotTable( _
        TableDestination:=wsPivot.Range("A3"), _
        TableName:="PivotTable1")
    
    ' Configura os campos da PivotTable
    With pt
        .PivotFields("Months").Orientation = xlColumnField
        .PivotFields("Vendor").Orientation = xlRowField
        .PivotFields("Forecast").Orientation = xlPageField
        
        ' Adiciona o campo de valores "FrancoValue"
        Set pivotField = .PivotFields("FrancoValue")
        pivotField.Orientation = xlDataField
        pivotField.Function = xlSum
        pivotField.NumberFormat = "#,##0.00"
    End With
    
    ' Aplica a formatação condicional
    On Error Resume Next
    Set dataBodyRange = pt.DataBodyRange
    On Error GoTo 0
    
    If Not dataBodyRange Is Nothing Then
        With dataBodyRange.FormatConditions
            ' Remove condições existentes
            .Delete
            
            ' Regra: Variação = 0% (Verde)
            .Add Type:=xlCellValue, Operator:=xlEqual, Formula1:="=0"
            With .Item(.Count)
                .Interior.Color = RGB(0, 255, 0)
            End With
            
            ' Regra: Variação entre 1% e 15% (Amarelo)
            .Add Type:=xlCellValue, Operator:=xlBetween, Formula1:="=0.01", Formula2:="=0.15"
            With .Item(.Count)
                .Interior.Color = RGB(255, 255, 0)
            End With
            
            ' Regra: Variação entre 15% e 50% (Laranja)
            .Add Type:=xlCellValue, Operator:=xlBetween, Formula1:="=0.15", Formula2:="=0.5"
            With .Item(.Count)
                .Interior.Color = RGB(255, 165, 0)
            End With
            
            ' Regra: Variação acima de 50% (Vermelho)
            .Add Type:=xlCellValue, Operator:=xlGreater, Formula1:="=0.5"
            With .Item(.Count)
                .Interior.Color = RGB(255, 0, 0)
            End With
        End With
    End If
    
    MsgBox "PivotTable criada e formatada na aba: " & pivotSheetName, vbInformation
End Sub

Sub CallCreatePivotTable()
    Dim wsSource As Worksheet
    
    ' Define a planilha de origem
    Set wsSource = ThisWorkbook.Sheets("NomeDaPlanilhaDeOrigem") ' Substitua pelo nome correto da planilha
    
    ' Chama a macro para criar a PivotTable
    CreatePivotTableInWorksheet wsSource
End Sub
