using System;
using System.IO;
using System.Text;
using QuickFix;

public class FixSessionFactory
{
    public static SessionSettings CriarSessaoFixComDictionary(string fixConfig, string base64Dictionary, string sessionIDStr)
    {
        // 1. Lê as configurações da sessão FIX a partir da string
        SessionSettings settings;
        using (var configStream = new MemoryStream(Encoding.UTF8.GetBytes(fixConfig)))
        {
            settings = new SessionSettings(configStream);
        }

        // 2. Decodifica o conteúdo base64 do DataDictionary
        var dictionaryBytes = Convert.FromBase64String(base64Dictionary);
        var dictionaryContent = Encoding.UTF8.GetString(dictionaryBytes);

        // 3. Cria o DataDictionary a partir da string (em memória)
        DataDictionary.DataDictionary dd;
        using (var dictStream = new MemoryStream(Encoding.UTF8.GetBytes(dictionaryContent)))
        {
            dd = new DataDictionary.DataDictionary(dictStream);
        }

        // 4. Configura o provedor de sessão usando o dictionary carregado
        var sessionID = new SessionID(sessionIDStr); // exemplo: "FIX.4.4:CLIENT->SERVER"

        var myApplication = new MyFixApplication(); // Implementação personalizada de IApplication
        var storeFactory = new MemoryStoreFactory();
        var logFactory = new ScreenLogFactory(true, true, true); // pode usar outras opções

        var messageFactory = new DefaultMessageFactory();

        var session = new Session(myApplication, storeFactory, sessionID, dd,
                                  settings.Get(sessionID), logFactory, messageFactory);

        return settings;
    }
}


string fixConfig = @"
[DEFAULT]
ConnectionType=initiator
ReconnectInterval=60
SenderCompID=CLIENT
TargetCompID=SERVER
BeginString=FIX.4.4
SocketConnectHost=127.0.0.1
SocketConnectPort=5001
StartTime=00:00:00
EndTime=23:59:59
HeartBtInt=30

[SESSION]
"; // você pode parametrizar isso

string base64Dictionary = Convert.ToBase64String(File.ReadAllBytes("FIX44.xml")); // exemplo
string sessionID = "FIX.4.4:CLIENT->SERVER";

var settings = FixSessionFactory.CriarSessaoFixComDictionary(fixConfig, base64Dictionary, sessionID);

