using Confluent.Kafka;
using Confluent.SchemaRegistry;
using Confluent.SchemaRegistry.Serdes;
using Google.Protobuf;
using System.Text;
using YamlDotNet.Serialization;
using System.Xml.Serialization;
using System.IO;
using System;

public static class KafkaMessageBuilder
{
    public static Message<string, object> BuildKafkaMessage(
        string key,
        object value,
        SerializationFormat format,
        ISchemaRegistryClient? schemaRegistryClient = null,
        string? schemaString = null)
    {
        switch (format)
        {
            case SerializationFormat.Avro:
                if (value is GenericRecord genericRecord)
                {
                    return new Message<string, object>
                    {
                        Key = key,
                        Value = genericRecord
                    };
                }
                throw new InvalidOperationException("For Avro, value must be of type GenericRecord.");

            case SerializationFormat.Json:
                var jsonPayload = System.Text.Json.JsonSerializer.Serialize(value);
                return new Message<string, object>
                {
                    Key = key,
                    Value = jsonPayload
                };

            case SerializationFormat.Protobuf:
                if (value is IMessage protoMessage)
                {
                    return new Message<string, object>
                    {
                        Key = key,
                        Value = protoMessage
                    };
                }
                throw new InvalidOperationException("For Protobuf, value must implement IMessage.");

            case SerializationFormat.Xml:
                var xmlSerializer = new XmlSerializer(value.GetType());
                using (var sw = new StringWriter())
                {
                    xmlSerializer.Serialize(sw, value);
                    return new Message<string, object>
                    {
                        Key = key,
                        Value = sw.ToString()
                    };
                }

            case SerializationFormat.Yaml:
                var serializer = new Serializer();
                string yaml = serializer.Serialize(value);
                return new Message<string, object>
                {
                    Key = key,
                    Value = yaml
                };

            default:
                throw new NotSupportedException($"Unsupported format: {format}");
        }
    }
}
