public static class Util
{
    public static T ValidateAndConvert<T>(object? input, List<Type> allowedTypes)
    {
        if (input == null) throw new ArgumentNullException(nameof(input));

        if (input is Envelope envelope)
        {
            if (typeof(T) == typeof(DataTable))
            {
                if (envelope.Content is DataTable dataTable)
                {
                    return (T)(object)dataTable;
                }
                else
                {
                    throw new InvalidOperationException($"The Envelope content is not of type DataTable");
                }
            }
        }
        else if (!allowedTypes.Contains(input.GetType()))
        {
            throw new InvalidOperationException($"The format {input.GetType()} is not in the allowed formats list");
        }
        return (T)Convert.ChangeType(input, typeof(T));
    }
}
