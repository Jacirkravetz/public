using System;
using System.Security.Cryptography;
using System.Text;

public static class RsaEncryptionHelper
{
    public static string EncryptWithRsaPublicKey(string publicKeyPem, string plaintext, int expectedKeySize = 2048)
    {
        if (string.IsNullOrWhiteSpace(publicKeyPem))
            throw new ArgumentException("Public key PEM cannot be null or empty.", nameof(publicKeyPem));

        if (!publicKeyPem.Contains("BEGIN PUBLIC KEY"))
            throw new ArgumentException("Invalid PEM format. Missing 'BEGIN PUBLIC KEY' header.");

        if (string.IsNullOrWhiteSpace(plaintext))
            throw new ArgumentException("Plaintext cannot be null or empty.", nameof(plaintext));

        try
        {
            byte[] dataToEncrypt = Encoding.UTF8.GetBytes(plaintext);

            using (RSA rsa = RSA.Create())
            {
                // Import public key
                rsa.ImportFromPem(publicKeyPem);

                // Validate key size
                int keySizeBits = rsa.KeySize;
                if (keySizeBits != expectedKeySize)
                {
                    throw new CryptographicException(
                        $"Invalid key size. Expected {expectedKeySize} bits but got {keySizeBits} bits.");
                }

                // Encrypt using OAEP with SHA-256
                byte[] encryptedBytes = rsa.Encrypt(dataToEncrypt, RSAEncryptionPadding.OaepSHA256);

                return Convert.ToBase64String(encryptedBytes);
            }
        }
        catch (CryptographicException cex)
        {
            // Cryptography-related error
            throw new InvalidOperationException("RSA encryption failed. Ensure the public key is valid.", cex);
        }
        catch (Exception ex)
        {
            // Generic safeguard
            throw new InvalidOperationException("Unexpected error during RSA encryption.", ex);
        }
    }
}
